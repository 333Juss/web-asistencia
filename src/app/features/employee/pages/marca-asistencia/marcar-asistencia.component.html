<div class="asistencia-container">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="60"></mat-spinner>
        <p>Cargando información...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading" class="content">

        <!-- Header Card -->
        <mat-card class="header-card">
            <div class="header-content">
                <div class="user-info">
                    <mat-icon class="user-avatar">account_circle</mat-icon>
                    <div class="user-details">
                        <h2 class="user-name" *ngIf="colaborador">
                            {{ colaborador.nombres }} {{ colaborador.apellidos }}
                        </h2>
                        <p class="user-sede" *ngIf="colaborador?.sede">
                            <mat-icon>store</mat-icon>
                            {{ colaborador?.sede?.nombre }}
                        </p>
                    </div>
                </div>
                <button mat-stroked-button (click)="verHistorial()" class="historial-button">
                    <mat-icon>history</mat-icon>
                    Ver Historial
                </button>
            </div>
        </mat-card>

        <!-- Status Card -->
        <mat-card class="status-card">
            <h3 class="card-title">Estado de Hoy</h3>
            <mat-divider></mat-divider>

            <div class="status-grid">
                <div class="status-item">
                    <div class="status-icon entrada">
                        <mat-icon>login</mat-icon>
                    </div>
                    <div class="status-details">
                        <label>Entrada</label>
                        <p class="time">{{ formatHora(asistenciaHoy?.horaEntrada) }}</p>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-icon salida">
                        <mat-icon>logout</mat-icon>
                    </div>
                    <div class="status-details">
                        <label>Salida</label>
                        <p class="time">{{ formatHora(asistenciaHoy?.horaSalida) }}</p>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-icon horas">
                        <mat-icon>schedule</mat-icon>
                    </div>
                    <div class="status-details">
                        <label>Horas Trabajadas</label>
                        <p class="time">{{ asistenciaHoy?.horasTrabajadas ? asistenciaHoy?.horasTrabajadas?.toFixed(2) +
                            'h' : '-' }}</p>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-icon" [class.estado-activo]="estadoAsistencia === 'En turno'"
                        [class.estado-completo]="estadoAsistencia === 'Completado'">
                        <mat-icon>{{ estadoAsistencia === 'En turno' ? 'fiber_manual_record' : (estadoAsistencia ===
                            'Completado' ? 'check_circle' : 'radio_button_unchecked') }}</mat-icon>
                    </div>
                    <div class="status-details">
                        <label>Estado</label>
                        <p class="time">{{ estadoAsistencia }}</p>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- Action Card -->
        <!-- Action Card -->
        <mat-card class="action-card" *ngIf="currentStep === 'idle'">
            <h3 class="card-title">Marcar Asistencia</h3>
            <mat-divider></mat-divider>

            <div class="action-buttons">
                <button mat-raised-button color="primary" (click)="iniciarMarcarEntrada()"
                    [disabled]="!puedeMarcarEntrada" class="action-button entrada-button">
                    <mat-icon>face</mat-icon>
                    <span>Marcar Entrada</span>
                    <small>Reconocimiento Facial + GPS</small>
                </button>

                <button mat-raised-button color="accent" (click)="iniciarMarcarSalida()" [disabled]="!puedeMarcarSalida"
                    class="action-button salida-button">
                    <mat-icon>face</mat-icon>
                    <span>Marcar Salida</span>
                    <small>Reconocimiento Facial + GPS</small>
                </button>
            </div>

            <div class="action-info" *ngIf="!puedeMarcarEntrada && !puedeMarcarSalida">
                <mat-icon>info</mat-icon>
                <p>Ya has completado tu registro de hoy</p>
            </div>
        </mat-card>

        <!-- Verification Card -->
        <mat-card class="verification-card" *ngIf="currentStep !== 'idle'">

            <!-- Step: Verificando Ubicación -->
            <div class="step-content" *ngIf="currentStep === 'verificando-ubicacion'">
                <div class="step-header">
                    <mat-spinner diameter="60"></mat-spinner>
                    <h3>Verificando Ubicación</h3>
                    <p>Obteniendo tu ubicación GPS...</p>
                </div>
            </div>

            <div class="step-content" *ngIf="currentStep === 'capturando-rostro'">
                <div class="step-header">
                    <mat-icon class="step-icon success">location_on</mat-icon>
                    <h3>Ubicación Verificada</h3>
                    <p class="success-text">Estás dentro del perímetro de la sede ({{ distancia?.toFixed(0) }}m)</p>
                </div>

                <mat-divider></mat-divider>

                <div class="camera-section">
                    <h4>
                        <mat-icon>{{ iconoMarcacion }}</mat-icon>
                        Reconocimiento Facial - {{ tipoMarcacion === 'entrada' ? 'Entrada' : 'Salida' }}
                    </h4>
                    <p class="instruction">Centra tu rostro en la cámara. Se requiere al menos 90% de coincidencia</p>

                    <app-camera-capture [maxImages]="1" [showPreview]="false" height="400px"
                        (imagesCaptures)="onImagesCaptured($event)">
                    </app-camera-capture>

                    <div class="capture-actions">
                        <button mat-button (click)="cancelar()">
                            <mat-icon>close</mat-icon>
                            Cancelar
                        </button>
                        <button mat-raised-button [color]="tipoMarcacion === 'entrada' ? 'primary' : 'accent'"
                            (click)="capturarRostro()">
                            <mat-icon>{{ iconoMarcacion }}</mat-icon>
                            {{ textoBotonCaptura }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step: Procesando -->
            <div class="step-content" *ngIf="currentStep === 'procesando'">
                <div class="step-header">
                    <mat-spinner diameter="60"></mat-spinner>
                    <h3>Procesando</h3>
                    <p>Verificando rostro y registrando asistencia...</p>
                </div>
            </div>

            <!-- Step: Completado -->
            <div class="step-content" *ngIf="currentStep === 'completado'">
                <div class="step-header">
                    <mat-icon class="step-icon success">check_circle</mat-icon>
                    <h3>¡Asistencia Registrada!</h3>
                    <p class="success-text">Tu asistencia ha sido registrada correctamente</p>
                </div>

                <div class="completion-info">
                    <div class="info-item" *ngIf="asistenciaHoy?.horaEntrada">
                        <label>Hora de Entrada</label>
                        <span>{{ formatHora(asistenciaHoy?.horaEntrada) }}</span>
                    </div>
                    <div class="info-item" *ngIf="asistenciaHoy?.horaSalida">
                        <label>Hora de Salida</label>
                        <span>{{ formatHora(asistenciaHoy?.horaSalida) }}</span>
                    </div>
                    <div class="info-item" *ngIf="asistenciaHoy?.horasTrabajadas">
                        <label>Horas Trabajadas</label>
                        <span>{{ asistenciaHoy?.horasTrabajadas?.toFixed(2) }}h</span>
                    </div>
                </div>
            </div>

        </mat-card>

        <!-- Tips Card -->
        <mat-card class="tips-card">
            <h4>
                <mat-icon>lightbulb</mat-icon>
                Consejos para marcar asistencia
            </h4>
            <ul>
                <li><strong>Ubicación:</strong> Debes estar dentro del perímetro de tu sede (máximo {{
                    colaborador?.sede?.radioMetros || 100 }}m)</li>
                <li><strong>Rostro:</strong> Asegúrate de tener buena iluminación y mira directamente a la cámara</li>
                <li><strong>Reconocimiento:</strong> Se requiere al menos 90% de coincidencia facial</li>
                <li><strong>Accesorios:</strong> Retira gafas, gorras o mascarillas que obstruyan tu rostro</li>
                <li><strong>Problemas:</strong> Si no puedes marcar, contacta a tu supervisor</li>
            </ul>
        </mat-card>

    </div>
</div>